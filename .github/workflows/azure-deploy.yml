name: Deploy to Azure App Service

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'terraform/**'
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: flight-tracker
  DOTNET_VERSION: '8.0.x'
  ACR_SERVER: flighttrackeracr6ebcf3aa.azurecr.io

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --configuration Release --no-restore

      - name: Run tests
        run: dotnet test --no-build --configuration Release --verbosity normal --filter "FullyQualifiedName!~PlaywrightUITests"

  build-and-push-docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test
    environment:
      name: Prod
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ACR_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Get build timestamp
        id: timestamp
        run: echo "time=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ env.ACR_SERVER }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          platforms: linux/amd64
          build-args: |
            GIT_COMMIT=${{ github.sha }}
            BUILD_TIME=${{ steps.timestamp.outputs.time }}

  deploy-to-azure:
    name: Deploy to Azure App Service
    runs-on: ubuntu-latest
    needs: build-and-push-docker
    environment:
      name: Prod
      url: ${{ steps.deploy.outputs.webapp-url }}
    
    steps:
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Discover Azure resources
        id: discover
        run: |
          # Hardcode for now - will fix auto-discovery later
          RG="flight-tracker-rg"
          WEBAPP="flighttracker-6ebcf3aa"
          
          echo "resource_group=$RG" >> $GITHUB_OUTPUT
          echo "webapp_name=$WEBAPP" >> $GITHUB_OUTPUT
          
          echo "‚úì Using: $WEBAPP in $RG"
          echo "DEBUG - resource_group output: $RG"
          echo "DEBUG - webapp_name output: $WEBAPP"

      - name: Configure App Service settings
        run: |
          az webapp config appsettings set \
            --name ${{ steps.discover.outputs.webapp_name }} \
            --resource-group ${{ steps.discover.outputs.resource_group }} \
            --settings \
              "Sentry__Dsn=${{ secrets.SENTRY_DSN }}" \
              "FlightProvider__ApiKey=${{ secrets.FLIGHT_PROVIDER_API_KEY }}" \
              "FlightProvider__ApiHost=${{ secrets.FLIGHT_PROVIDER_API_HOST }}" \
              "FlightProvider__Type=${{ secrets.FLIGHT_PROVIDER_TYPE }}"

      - name: Deploy to Azure Web App
        id: deploy
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ steps.discover.outputs.webapp_name }}
          images: ${{ env.ACR_SERVER }}/${{ env.DOCKER_IMAGE_NAME }}:latest

      - name: Restart App Service
        run: |
          az webapp restart \
            --name ${{ steps.discover.outputs.webapp_name }} \
            --resource-group ${{ steps.discover.outputs.resource_group }}

      - name: Check deployment status
        run: |
          echo "üöÄ Deployment completed!"
          echo "üåê App URL: https://${{ steps.discover.outputs.webapp_name }}.azurewebsites.net"
          
          # Wait for app to be ready (container pull + startup)
          echo "‚è≥ Waiting 60s for container to start..."
          sleep 60
          
          # Liveness check with retry logic
          echo "üîç Checking app liveness..."
          MAX_RETRIES=5
          RETRY_DELAY=15
          
          for i in $(seq 1 $MAX_RETRIES); do
            LIVENESS_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://${{ steps.discover.outputs.webapp_name }}.azurewebsites.net/health/live)
            
            if [ "$LIVENESS_CODE" -eq 200 ]; then
              echo "‚úÖ App is running (HTTP $LIVENESS_CODE)"
              break
            fi
            
            if [ $i -eq $MAX_RETRIES ]; then
              echo "‚ùå App liveness check failed after $MAX_RETRIES attempts (last HTTP $LIVENESS_CODE)"
              echo "‚ö†Ô∏è The app may still be starting up. Check Azure Portal for container logs."
              # Don't fail the deployment - the app might just need more time
              echo "::warning::App liveness check did not pass. The container may still be initializing."
              exit 0
            fi
            
            echo "‚è≥ Attempt $i/$MAX_RETRIES failed (HTTP $LIVENESS_CODE). Waiting ${RETRY_DELAY}s..."
            sleep $RETRY_DELAY
          done
          
          # Full health check (app + database)
          echo "üîç Checking database health..."
          HEALTH_RESPONSE=$(curl -s --max-time 10 https://${{ steps.discover.outputs.webapp_name }}.azurewebsites.net/health)
          echo "Health response: $HEALTH_RESPONSE"
          
          HEALTH_STATUS=$(echo "$HEALTH_RESPONSE" | jq -r '.status')
          if [ "$HEALTH_STATUS" = "Healthy" ]; then
            echo "‚úÖ All health checks passed!"
          else
            echo "‚ö†Ô∏è Health check status: $HEALTH_STATUS"
            echo "Full response: $HEALTH_RESPONSE"
          fi

      - name: Logout from Azure
        run: az logout
        if: always()

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [build-and-test, build-and-push-docker, deploy-to-azure]
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check the logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          # Add Slack/Teams/Email notification here if needed
